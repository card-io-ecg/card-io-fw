<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Card/IO configuration</title>
    <style type="text/css">
        @font-face {
            font-family: Poppins;
            src: url(/font);
        }

        body {
            background-color: #ddd;
            font-family: Arial, Helvetica, sans-serif;
            font-size: 14px;
            padding: 1em;
        }

        .hidden {
            display: none;
        }

        #toast {
            position: absolute;
            top: 0;
            left: 50%;
            transform: translateX(-50%);
            padding: 2em;
            max-width: 800px;
        }

        #toast div {
            background-color: #555;
            border-radius: 2em;
            color: #fff;
            padding: 1em;
        }

        .fade {
            animation: fade 3s;
        }

        @keyframes fade {
            0% {
                opacity: 1;
            }

            100% {
                opacity: 0;
            }
        }

        #frame {
            margin: 0 auto;
            max-width: 800px;
            padding: 1em;
        }

        #header h1,
        #logo {
            display: inline-block;
            vertical-align: bottom;
        }

        #header h1 {
            margin: 0;
            padding: 0;
            font: 3em Poppins;
            font-weight: normal;
            color: #000;
        }

        #logo {
            float: right;
            cursor: pointer;
        }

        #content {
            padding: 1em;
            background-color: #eee;
            border-radius: 1em;
        }

        .center {
            text-align: center;
        }

        .tpl {
            display: none;
        }
    </style>
</head>

<body>
    <div id="toast" class="hidden">
        <div>This is a test toast message</div>
    </div>
    <div id="frame">
        <div id="header-container">
            <span id="header"></span>
            <svg id="logo" viewBox="0 0 287 101" width="150" height="62">
                <path
                    d="M 1.944 57.912 Q 3.024 51.648 6.408 46.968 Q 9.792 42.288 14.796 39.768 Q 19.8 37.248 25.704 37.248 Q 33.264 37.248 37.656 41.208 Q 42.048 45.168 42.336 52.368 L 29.232 52.368 Q 28.44 47.76 23.616 47.76 Q 20.232 47.76 17.784 50.388 Q 15.336 53.016 14.472 57.912 Q 14.184 59.424 14.184 61.08 Q 14.184 64.464 15.768 66.264 Q 17.352 68.064 20.088 68.064 Q 24.84 68.064 27.216 63.456 L 40.392 63.456 Q 37.584 70.512 31.752 74.544 Q 25.92 78.576 18.432 78.576 Q 10.656 78.576 6.084 74.292 Q 1.512 70.008 1.512 62.592 Q 1.512 60.36 1.944 57.912 Z M 45.503 57.84 Q 46.583 51.648 49.751 46.968 Q 52.919 42.288 57.383 39.768 Q 61.847 37.248 66.815 37.248 Q 71.063 37.248 73.943 38.976 Q 76.823 40.704 78.119 43.512 L 79.127 37.824 L 91.439 37.824 L 84.311 78 L 71.999 78 L 73.079 72.312 Q 70.775 75.12 67.247 76.848 Q 63.719 78.576 59.471 78.576 Q 55.223 78.576 51.947 76.632 Q 48.671 74.688 46.871 71.124 Q 45.071 67.56 45.071 62.736 Q 45.071 60.432 45.503 57.84 Z M 75.599 57.912 Q 75.815 56.616 75.815 55.536 Q 75.815 52.008 73.763 49.992 Q 71.711 47.976 68.543 47.976 Q 64.871 47.976 61.847 50.604 Q 58.823 53.232 58.031 57.84 Q 57.815 59.136 57.815 60.216 Q 57.815 63.744 59.867 65.796 Q 61.919 67.848 65.015 67.848 Q 68.687 67.848 71.711 65.184 Q 74.735 62.52 75.599 57.912 Z M 111.307 45.096 Q 114.115 41.496 117.751 39.444 Q 121.387 37.392 125.347 37.392 L 123.043 50.424 L 119.659 50.424 Q 115.051 50.424 112.387 52.404 Q 109.723 54.384 108.859 59.352 L 105.547 78 L 93.235 78 L 100.291 37.824 L 112.603 37.824 L 111.307 45.096 Z M 125.204 57.84 Q 126.284 51.648 129.452 46.968 Q 132.62 42.288 137.084 39.768 Q 141.548 37.248 146.516 37.248 Q 150.476 37.248 153.464 38.904 Q 156.452 40.56 157.82 43.368 L 161.132 24.72 L 173.444 24.72 L 164.012 78 L 151.7 78 L 152.708 72.24 Q 150.404 75.12 146.948 76.848 Q 143.492 78.576 139.244 78.576 Q 134.996 78.576 131.72 76.632 Q 128.444 74.688 126.608 71.088 Q 124.772 67.488 124.772 62.664 Q 124.772 60.432 125.204 57.84 Z M 155.3 57.912 Q 155.516 56.616 155.516 55.536 Q 155.516 52.008 153.464 49.992 Q 151.412 47.976 148.244 47.976 Q 144.572 47.976 141.548 50.604 Q 138.524 53.232 137.732 57.84 Q 137.516 59.136 137.516 60.216 Q 137.516 63.744 139.568 65.796 Q 141.62 67.848 144.716 67.848 Q 148.388 67.848 151.412 65.184 Q 154.436 62.52 155.3 57.912 Z"
                    style="white-space: pre;" />
                <path
                    d="M 194.008 18.48 C 191.896 18.48 190.2 17.872 188.92 16.656 C 187.64 15.44 187 13.904 187 12.048 C 187 9.488 187.976 7.296 189.928 5.472 C 191.88 3.648 194.168 2.736 196.792 2.736 C 198.84 2.736 200.504 3.344 201.784 4.56 C 203.064 5.776 203.704 7.312 203.704 9.168 C 203.704 11.728 202.744 13.92 200.824 15.744 C 198.904 17.568 196.632 18.48 194.008 18.48 Z M 199.576 24.816 L 195.563 47.5 L 182.027 47.5 L 186.04 24.816 L 199.576 24.816 Z M 190.168 78 L 176.632 78 L 179.738 60.444 C 180.019 60.481 180.306 60.5 180.598 60.5 L 193.264 60.5 L 190.168 78 Z M 215.078 76.08 C 211.59 74.224 208.886 71.6 206.966 68.208 C 205.648 65.88 204.783 63.311 204.369 60.5 L 218.744 60.5 C 219.248 61.979 220.01 63.236 221.03 64.272 C 221.452 64.7 221.901 65.084 222.377 65.423 L 220.576 75.531 L 220.131 78.028 C 218.339 77.568 216.654 76.919 215.078 76.08 Z M 208.358 40.032 C 211.206 35.072 215.11 31.152 220.07 28.272 C 221.735 27.305 223.464 26.5 225.255 25.858 L 217.839 47.5 L 205.252 47.5 C 205.962 44.89 206.998 42.401 208.358 40.032 Z M 248.774 26.784 C 252.326 28.672 255.078 31.312 257.03 34.704 C 258.982 38.096 259.958 42 259.958 46.416 C 259.958 46.779 259.953 47.141 259.943 47.5 L 246.038 47.5 C 246.038 47.491 246.038 47.481 246.038 47.472 C 246.038 43.632 244.966 40.672 242.822 38.592 C 242.154 37.944 241.432 37.397 240.655 36.951 L 242.855 24.61 C 244.961 25.081 246.934 25.806 248.774 26.784 Z M 255.638 62.928 C 252.758 67.856 248.806 71.744 243.782 74.592 C 240.566 76.415 237.134 77.654 233.486 78.311 L 243.217 60.5 L 256.918 60.5 C 256.529 61.324 256.102 62.134 255.638 62.928 Z M 221.271 73.554 L 224.991 66.745 C 224.991 66.745 224.991 66.745 224.991 66.745 L 221.271 73.554 Z"
                    style="fill: rgb(0, 0, 0); white-space: pre;" />
                <path
                    style="fill: none; stroke-linejoin: round; stroke-linecap: square; stroke: rgb(0, 0, 0); stroke-width: 4px;"
                    d="M 272 54 L 239.362 54 L 226.975 76.671 L 239.7253852 5.122 L 222.483 54 L 182.483 54" />
            </svg>
        </div>

        <div id="content"></div>
    </div>

    <!-- templates -->
    <div id="demo" class="tpl">
        <h1 class="header">Welcome!</h1>
        <div class="content">
            Firmware version: <span class="fw"></span>
            Known networks: <span class="kn"></span>
            <button id="btn_nn">Add network</button>
        </div>
    </div>

    <div id="network" class="tpl">
        SSID: <span class="data"></span>
    </div>

    <div id="nn" class="tpl">
        <h1 class="header">Add network</h1>
        <div class="content">
            <form id="form">
                <label for="ssid">SSID</label><br />
                <input type="text" id="ssid" name="ssid" /><br />
                <label for="password">Password</label><br />
                <input type="password" id="password" name="password" /><br />
            </form>
            <button onclick="$fe.add_new_network();">Submit</button>
            <button id="btn_back">Back</button>
        </div>
    </div>

    <div id="spinner" class="content center tpl">
        Loading...
    </div>
</body>

<script>
    $id = (id) => document.getElementById(id);
    $on = (id, evt, cb) => {
        let c = $id(id);
        if (c) c.addEventListener(evt, cb);
    }

    // Substitute `value` into `tpl`, replacing the inner html of the element with class `name`.
    // If `sep` is specified, `value` is split on `sep` and each element is substituted into
    // the corresponding element with class `name-<index>`.
    $set = (tpl, name, value, sep = undefined) => {
        if (sep) {
            for (let [i, field] of line.split(sep).entries()) {
                $set(tpl, name + "-" + i, field);
            }
        } else {
            tpl.querySelector("." + name).innerHTML = value;
        }
    }

    $tpl = (id) => {
        let tpl = $id(id).cloneNode(true);
        tpl.classList.remove("tpl");

        let c = tpl.querySelector(".content");
        if (c) {
            c.set = (name, value, sep = undefined) => $set(tpl, name, value, sep);
            c.set_list = (name, item_tpl, value, sep = undefined) => {
                // value is a newline-delimited list of items
                let item_template = $tpl(item_tpl);
                let list_node = tpl.querySelector("." + name);

                let lines = value.split("\n");

                if (lines.length && lines[lines.length - 1].trim() == "") {
                    lines.pop();
                }

                for (let line of lines) {
                    let node = item_template.cloneNode(true);
                    $set(node, "data", line, sep);
                    list_node.appendChild(node);
                }
            }
        }

        return tpl;
    }
    $show = (id, n) => {
        let e = $id(id);
        while (e.firstChild) {
            e.removeChild(e.lastChild);
        }
        e.appendChild(n);
    }
    $page = async (tpln, fn) => {
        let tpl = $tpl(tpln);

        $show("header", tpl.querySelector(".header"));

        // Prevent rapid flashing
        let delay;
        let loaded;
        new Promise((res) => setTimeout(res, 100)).then(() => {
            if (!loaded) {
                delay = new Promise((res) => setTimeout(res, 500));
                $show("content", $tpl("spinner"));
            }
        });

        let node = tpl.querySelector(".content");
        if (fn) await fn(node);
        loaded = true;
        if (delay) await delay;

        $show("content", node);

        $on("btn_nn", "click", $fe.nn);
        $on("btn_back", "click", $fe.start);
    }
    $load = async (url, retry = 5) => {
        for (let i = 0; i < retry; i++) {
            try {
                return await $fetch(url);
            } catch (e) {
                if (i == retry - 1) {
                    $toast(`Failed to load page: ${e.message}`);
                } else {
                    console.log(e);
                }
            }
        }
    }

    var toastTimeout;
    $toast = (message) => {
        console.log(`[toast] ${message}`);

        let toast = $id("toast");
        toast.children[0].innerHTML = message;
        toast.classList.remove("hidden");
        toast.classList.remove("fade");

        if (toastTimeout) clearTimeout(toastTimeout);
        toastTimeout = setTimeout(() => {
            toast.classList.add("fade");
            toastTimeout = setTimeout(() => {
                toast.classList.add("hidden");
                toast.classList.remove("fade");
                toastTimeout = null;
            }, 3000);
        }, 1000);
    }
    $fetch = async (url, params = undefined) => {
        let result = await fetch(url, params);

        if (!result.ok) {
            let message = await result.text();
            throw new Error(`[${result.status}] ${message}`);
        }

        return result;
    }

    let dom_rdy = false;
    let fonts_rdy = false;

    $fe = {
        start: () => $page('demo', async (tpl) => {
            let system_info = await $load('/si');
            let known_networks = await $load('/kn');

            tpl.set("fw", await system_info.text());
            tpl.set_list("kn", "network", await known_networks.text());
        }),

        nn: () => $page('nn'),

        add_new_network: async () => {
            let form = $id("content").querySelector("#form");
            let ssid = form.querySelector("#ssid").value;
            let pass = form.querySelector("#password").value;

            try {
                await $fetch('/nn', {
                    method: 'POST',
                    body: ssid + "\n" + pass
                });
                $fe.start();
            } catch (e) {
                $toast(`Failed to add network: ${e.message}`);
            }
        }
    };

    document.addEventListener("DOMContentLoaded", () => {
        dom_rdy = true;

        if (fonts_rdy) {
            $fe.start();
        }
    });
    document.fonts.ready.then(() => {
        fonts_rdy = true;

        if (dom_rdy) {
            $fe.start();
        }
    });
</script>

</html>