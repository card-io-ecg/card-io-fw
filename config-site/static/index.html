<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Card/IO configuration</title>
    <style type="text/css">
        body {
            font-family: 'Segoe UI';
            background-color: #ddd;
            font-size: 14px;
            padding: 1em;
        }

        #frame {
            margin: 0 auto;
            max-width: 800px;
            padding: 1em;
        }

        #header h1,
        #logo {
            display: inline-block;
            vertical-align: middle;
        }

        #header h1 {
            margin: 0;
            padding: 0;
            font: 3em 'Segoe UI';
            font-weight: normal;
            color: #333;
        }

        #logo {
            fill: #333;
            stroke: #333;
            font-family: 'Segoe UI';
            float: right;
            cursor: pointer;
        }

        #content {
            margin-top: 1em;
            padding: 1em;
            background-color: #eee;
            border-radius: 1em;
        }

        .center {
            text-align: center;
        }

        .tpl {
            display: none;
        }
    </style>
</head>

<body>
    <div id="frame">
        <div id="header-container">
            <span id="header"></span>
            <svg id="logo" viewBox="80 60 150 90" width="120" height="60">
                <text style="font-size: 44px;" x="77.386" y="107" dx="0 0 0 0 9.302">Card
                    IO</text>
                <path style="fill-opacity: 0; stroke-linecap: round; stroke-linejoin: round; stroke-width: 3px;"
                    d="M 80.55 113.063 L 170.418 112.824 L 178.571 74.279 L 187.51 138.286 L 192.926 112.422 L 228.61 112.497">
                </path>
                <text style="font-size: 20px;" x="110" y="137">2023</text>
            </svg>
        </div>

        <div id="content"></div>
    </div>

    <div id="demo" class="tpl">
        <h1 class="header">Welcome!</h1>
        <div class="content">
            <span class="data"></span><br />
            Firmware version: <span class="fw"></span>
            Known networks: <span class="kn"></span>
            <!--button id="btn_nn">Add network</button-->
        </div>
    </div>

    <div id="network" class="tpl">
        Known network <span class="data"></span>
    </div>

    <div id="nn" class="tpl">
        <h1 class="header">Add network</h1>
        <div class="content">
            <form id="form">
                <label for="ssid">SSID</label><br />
                <input type="text" id="ssid" name="ssid" /><br />
                <label for="password">Password</label><br />
                <input type="password" id="password" name="password" /><br />
                <input type="submit" value="Submit" />
            </form>
            <button id="btn_back">Back</button>
        </div>
    </div>

    <div id="spinner" class="content center tpl">
        Loading...
    </div>
</body>

<script>
    $id = (id) => document.getElementById(id);
    $on = (id, evt, cb) => {
        let c = $id(id);
        if (c) c.addEventListener(evt, cb);
    }
    $tpl = (id) => {
        let tpl = $id(id).cloneNode(true);
        tpl.classList.remove("tpl");

        let c = tpl.querySelector(".content");
        if (c) {
            c.set = (name, value) => {
                // TODO: support multiple fields
                tpl.querySelector("." + name).innerHTML = value;
            }
            c.set_list = (name, item_tpl, value) => {
                // value is a newline-delimited list of items
                // TODO: support multiple fields
                let item_template = $tpl(item_tpl);
                let list_node = tpl.querySelector("." + name);

                let lines = value.split("\n");
                for (let line of lines) {
                    let node = item_template.cloneNode(true);
                    node.querySelector(".data").innerHTML = line;
                    list_node.appendChild(node);
                }
            }
        }

        return tpl;
    }
    $show = (id, n) => {
        let e = $id(id);
        while (e.firstChild) {
            e.removeChild(e.lastChild);
        }
        e.appendChild(n);
    }
    $page = async (tpln, fn) => {
        let tpl = $tpl(tpln);

        $show("header", tpl.querySelector(".header"));

        // Prevent rapid flashing
        let delay;
        let loaded;
        new Promise((res) => setTimeout(res, 100)).then(() => {
            if (!loaded) {
                delay = new Promise((res) => setTimeout(res, 500));
                $show("content", $tpl("spinner"));
            }
        });

        let node = tpl.querySelector(".content");
        if (fn) await fn(node);
        loaded = true;
        if (delay) await delay;

        $show("content", node);

        $on("btn_nn", "click", $fe.nn);
        $on("btn_back", "click", $fe.start);
    }

    $fe = {
        start: () => $page('demo', async (tpl) => {
            let demo = await fetch('/demo');
            let system_info = await fetch('/si');
            let known_networks = await fetch('/kn');

            tpl.set("data", await demo.text());
            tpl.set("fw", await system_info.text());
            tpl.set_list("kn", "network", await known_networks.text());
        }),

        nn: () => $page('nn')
    };

    document.addEventListener("DOMContentLoaded", $fe.start);
</script>

</html>